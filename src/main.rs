use rand::Rng;
use std::io::{Read, Write};
use std::net::{Ipv4Addr, Ipv6Addr, SocketAddr, TcpStream};
use std::process::Child;
use std::time::Duration;

fn main() {
    let sock_ipv4 = SocketAddr::from((Ipv4Addr::UNSPECIFIED, 5007));
    let sock_ipv6 = SocketAddr::from((Ipv6Addr::UNSPECIFIED, 5007));

    let socket = std::net::TcpListener::bind([sock_ipv6, sock_ipv4].as_slice()).unwrap();

    let mut rng = rand::thread_rng();

    for connection in socket.incoming() {
        match connection {
            Err(err) => eprint!("{}", err),
            Ok(con) => handle_connection(con, rng.gen_range(5008..=65535)),
        }
    }
}

fn spawn_lsp(port: u16) -> Child {
    let home_dir = std::env::var("HOME").unwrap();
    std::process::Command::new("/usr/lib/jvm/java-1.14.0-openjdk-amd64/bin/java")
            .env("CLASSPATH", format!("{home}/.p2/pool/plugins/com.google.gson_2.8.6.v20201231-1626.jar:{home}/.p2/pool/plugins/com.google.guava_30.1.0.v20210127-2300.jar:{home}/.p2/pool/plugins/org.eclipse.core.runtime_3.22.0.v20210506-1025.jar:{home}/.p2/pool/plugins/org.eclipse.osgi_3.16.300.v20210525-1715.jar:{home}/.p2/pool/plugins/javax.transaction_1.1.1.v201105210645.jar:{home}/.p2/pool/plugins/org.eclipse.osgi.compatibility.state_1.2.400.v20210401-1438.jar:{home}/.p2/pool/plugins/org.eclipse.equinox.common_3.15.0.v20210518-0604.jar:{home}/.p2/pool/plugins/org.eclipse.core.jobs_3.11.0.v20210420-1453.jar:{home}/.p2/pool/plugins/org.eclipse.equinox.registry_3.10.200.v20210503-1606.jar:{home}/.p2/pool/plugins/org.eclipse.equinox.preferences_3.8.200.v20210212-1143.jar:{home}/.p2/pool/plugins/org.eclipse.core.contenttype_3.7.1000.v20210409-1722.jar:{home}/.p2/pool/plugins/org.eclipse.equinox.app_1.5.100.v20210212-1143.jar:{home}/.p2/pool/plugins/org.eclipse.core.resources_3.15.0.v20210521-0722.jar:{home}/.p2/pool/plugins/org.eclipse.ui_3.119.0.v20210111-1350.jar:{home}/.p2/pool/plugins/org.eclipse.swt_3.116.100.v20210602-2209.jar:{home}/.p2/pool/plugins/org.eclipse.swt.gtk.linux.x86_64_3.116.100.v20210602-2209.jar:{home}/.p2/pool/plugins/org.eclipse.jface_3.22.200.v20210401-0958.jar:{home}/.p2/pool/plugins/org.eclipse.core.commands_3.10.0.v20210401-0744.jar:{home}/.p2/pool/plugins/org.eclipse.ui.workbench_3.122.200.v20210506-1640.jar:{home}/.p2/pool/plugins/org.eclipse.e4.ui.workbench3_0.15.500.v20201021-1339.jar:{home}/.p2/pool/plugins/org.eclipse.emf.ecore.xmi_2.16.0.v20190528-0725.jar:{home}/.p2/pool/plugins/org.eclipse.emf.ecore_2.24.0.v20210405-0628.jar:{home}/.p2/pool/plugins/org.eclipse.emf.common_2.22.0.v20210319-0732.jar:{home}/.p2/pool/plugins/org.eclipse.elk.graph_0.7.1.jar:{home}/.p2/pool/plugins/org.eclipse.elk.core_0.7.1.jar:{home}/Git/kieler/pragmatics/plugins/de.cau.cs.kieler.formats/bin:{home}/.p2/pool/plugins/org.eclipse.xtext.xbase.lib_2.25.0.v20210301-0821.jar:{home}/.p2/pool/plugins/org.eclipse.xtend.lib_2.25.0.v20210301-0821.jar:{home}/.p2/pool/plugins/org.eclipse.xtend.lib.macro_2.25.0.v20210301-0821.jar:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.kgraph/bin:{home}/Git/kieler/pragmatics/plugins/de.cau.cs.kieler.formats.kgraph/bin:{home}/.p2/pool/plugins/org.eclipse.xtext_2.25.0.v20210301-0843.jar:{home}/.p2/pool/plugins/org.antlr.runtime_3.2.0.v201101311130.jar:{home}/.p2/pool/plugins/com.google.inject_5.0.1.v20210324-2015.jar:{home}/.p2/pool/plugins/org.eclipse.emf.mwe.core_1.6.1.v20210218-2134.jar:{home}/.p2/pool/plugins/org.apache.commons.cli_1.4.0.v20200417-1444.jar:{home}/.p2/pool/plugins/org.eclipse.emf.mwe2.runtime_2.12.1.v20210218-2134.jar:{home}/.p2/pool/plugins/org.eclipse.emf.mwe.utils_1.6.1.v20210218-2134.jar:{home}/.p2/pool/plugins/org.eclipse.xtext.util_2.25.0.v20210301-0843.jar:{home}/.p2/pool/plugins/javax.inject_1.0.0.v20091030.jar:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.krendering/bin:{home}/.p2/pool/plugins/org.eclipse.elk.core.service_0.7.1.jar:{home}/.p2/pool/plugins/org.eclipse.emf.edit_2.16.0.v20190920-0401.jar:{home}/.p2/pool/plugins/org.eclipse.emf.ecore.change_2.14.0.v20190528-0725.jar:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd/bin:{home}/.p2/pool/plugins/org.eclipse.xtext.xbase_2.25.0.v20210301-0909.jar:{home}/.p2/pool/plugins/org.eclipse.xtext.common.types_2.25.0.v20210301-0909.jar:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.krendering.extensions/bin:{home}/.p2/pool/plugins/org.eclipse.elk.alg.layered_0.7.1.jar:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.ide/bin:{home}/Git/kieler/pragmatics/plugins/de.cau.cs.kieler.formats.gml/bin:{home}/.p2/pool/plugins/org.eclipse.core.expressions_3.7.100.v20210203-1000.jar:{home}/.p2/pool/plugins/org.eclipse.elk.alg.rectpacking_0.7.1.jar:{home}/Git/kieler/pragmatics/plugins/de.cau.cs.kieler.graphs.klighd/bin:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.kgraph.text/bin:{home}/.p2/pool/plugins/org.eclipse.xtext.generator_2.25.0.v20210301-0909.jar:{home}/.p2/pool/plugins/org.eclipse.xtext.xtext.generator_2.25.0.v20210301-0843.jar:{home}/.p2/pool/plugins/org.eclipse.emf.codegen.ecore_2.26.0.v20210506-1425.jar:{home}/.p2/pool/plugins/org.eclipse.emf.codegen_2.22.0.v20210420-0623.jar:{home}/.p2/pool/plugins/org.eclipse.xtend_2.2.0.v201605260315.jar:{home}/.p2/pool/plugins/com.ibm.icu_67.1.0.v20200706-1749.jar:{home}/.p2/pool/plugins/org.eclipse.xpand_2.2.0.v201605260315.jar:{home}/.p2/pool/plugins/org.eclipse.xtend.typesystem.emf_2.2.0.v201605260315.jar:{home}/.p2/pool/plugins/org.eclipse.emf.mwe2.lib_2.12.1.v20210218-2134.jar:{home}/.p2/pool/plugins/org.apache.commons.logging_1.2.0.v20180409-1502.jar:{home}/.p2/pool/plugins/org.eclipse.emf.mwe2.launch_2.12.1.v20210218-2134.jar:{home}/.p2/pool/plugins/org.eclipse.emf.mwe2.language_2.12.1.v20210218-2134.jar:{home}/.p2/pool/plugins/org.apache.log4j_1.2.15.v201012070815.jar:{home}/.p2/pool/plugins/org.eclipse.xtext.ide_2.25.0.v20210301-0843.jar:{home}/.p2/pool/plugins/org.eclipse.xtext.xbase.ide_2.25.0.v20210301-0909.jar:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.kgraph.text.ide/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.annotations/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.kexpressions/bin:{home}/.p2/pool/plugins/org.freemarker_2.3.22.v20160210-1233.jar:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.core/bin:{home}/.p2/pool/plugins/org.objectweb.asm_9.1.0.v20210209-1849.jar:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.kicool/bin:{home}/.p2/pool/plugins/edu.umd.cs.piccolo_1.3.4.v20200330.jar:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.piccolo/bin:{home}/.p2/pool/plugins/org.eclipse.elk.alg.common_0.7.1.jar:{home}/.p2/pool/plugins/org.eclipse.elk.alg.force_0.7.1.jar:{home}/.p2/pool/plugins/org.eclipse.elk.alg.graphviz.dot_0.7.1.jar:{home}/.p2/pool/plugins/org.eclipse.elk.alg.graphviz.layouter_0.7.1.jar:{home}/.p2/pool/plugins/org.eclipse.elk.alg.mrtree_0.7.1.jar:{home}/.p2/pool/plugins/org.eclipse.elk.alg.radial_0.7.1.jar:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.standalone/bin:{home}/.p2/pool/plugins/org.eclipse.lsp4j_0.10.0.v20201105-1103.jar:{home}/.p2/pool/plugins/org.eclipse.lsp4j.generator_0.10.0.v20201105-1103.jar:{home}/.p2/pool/plugins/org.eclipse.lsp4j.jsonrpc_0.10.0.v20201105-1103.jar:{home}/.p2/pool/plugins/org.eclipse.sprotty_0.9.0.jar:{home}/oomph/kieler-semantics-keith/ws/.metadata/.plugins/org.eclipse.pde.core/.external_libraries/org.eclipse.sprotty_0.9.0/lib/org.eclipse.sprotty-0.9.0.jar:{home}/oomph/kieler-semantics-keith/ws/.metadata/.plugins/org.eclipse.pde.core/.external_libraries/org.eclipse.sprotty_0.9.0/lib/org.eclipse.sprotty.server-0.9.0.jar:{home}/oomph/kieler-semantics-keith/ws/.metadata/.plugins/org.eclipse.pde.core/.external_libraries/org.eclipse.sprotty_0.9.0/lib/org.eclipse.sprotty.xtext-0.9.0.jar:{home}/oomph/kieler-semantics-keith/ws/.metadata/.plugins/org.eclipse.pde.core/.external_libraries/org.eclipse.sprotty_0.9.0/lib/org.eclipse.sprotty.layout-0.9.0.jar:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.lsp/bin:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.incremental/bin:{home}/.p2/pool/plugins/org.eclipse.elk.graph.text_0.7.1.jar:{home}/.p2/pool/plugins/org.eclipse.elk.graph.text.ide_0.7.1.jar:{home}/Git/kieler/pragmatics/plugins/de.cau.cs.kieler.pragmatics.language.server/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.scg/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.scl/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.sccharts/bin:{home}/.p2/pool/plugins/org.aopalliance_1.0.0.v201105210816.jar:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.language.server/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.annotations.ide/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.annotations.ui/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.c.sccharts/bin:{home}/.p2/pool/plugins/org.eclipse.cdt.core_7.2.100.202105180159.jar:{home}/.p2/pool/plugins/org.eclipse.cdt.core.native_6.1.200.202105261421.jar:{home}/.p2/pool/plugins/org.eclipse.cdt_10.3.0.202104042017.jar:{home}/.p2/pool/plugins/org.eclipse.cdt.ui_7.2.0.202106050127.jar:{home}/.p2/pool/plugins/org.eclipse.xtext.ui_2.25.0.v20210301-0928.jar:{home}/.p2/pool/plugins/org.eclipse.ui.editors_3.14.100.v20210513-1110.jar:{home}/.p2/pool/plugins/org.eclipse.core.filebuffers_3.7.0.v20210512-1543.jar:{home}/.p2/pool/plugins/org.eclipse.jface.text_3.18.0.v20210512-1640.jar:{home}/.p2/pool/plugins/org.eclipse.text_3.12.0.v20210512-1644.jar:{home}/.p2/pool/plugins/org.eclipse.emf.edit.ui_2.20.0.v20210506-1232.jar:{home}/.p2/pool/plugins/org.eclipse.ui.views_3.11.0.v20210111-1351.jar:{home}/.p2/pool/plugins/org.eclipse.emf.common.ui_2.18.0.v20190507-0402.jar:{home}/.p2/pool/plugins/org.eclipse.ltk.core.refactoring_3.11.400.v20210427-0555.jar:{home}/.p2/pool/plugins/org.eclipse.xtext.ui.shared_2.25.0.v20210301-0928.jar:{home}/.p2/pool/plugins/org.eclipse.emf.compare_3.5.3.202102231741.jar:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.kicool.ide/bin:{home}/.p2/pool/plugins/org.eclipse.xtext.builder_2.25.0.v20210301-0928.jar:{home}/.p2/pool/plugins/org.eclipse.debug.ui_3.15.0.v20210525-1810.jar:{home}/.p2/pool/plugins/org.eclipse.debug.core_3.18.100.v20210511-0446.jar:{home}/.p2/pool/plugins/org.eclipse.xtext.common.types.ui_2.25.0.v20210301-0928.jar:{home}/.p2/pool/plugins/org.eclipse.xtext.common.types.edit_2.25.0.v20210301-0928.jar:{home}/.p2/pool/plugins/org.eclipse.ui.workbench.texteditor_3.16.100.v20210512-1009.jar:{home}/.p2/pool/plugins/org.eclipse.emf_2.8.0.v20180706-1146.jar:{home}/.p2/pool/plugins/org.eclipse.ui.ide_3.18.200.v20210523-1724.jar:{home}/.p2/pool/plugins/org.eclipse.e4.ui.ide_3.15.200.v20210108-1832.jar:{home}/.p2/pool/plugins/org.eclipse.ui.forms_3.11.100.v20210108-1139.jar:{home}/.p2/pool/plugins/org.eclipse.core.databinding_1.10.100.v20200926-1123.jar:{home}/.p2/pool/plugins/org.eclipse.core.databinding.observable_1.10.0.v20200730-0848.jar:{home}/.p2/pool/plugins/org.eclipse.core.databinding.beans_1.7.200.v20210111-0759.jar:{home}/.p2/pool/plugins/org.eclipse.jface.databinding_1.12.200.v20210111-0911.jar:{home}/.p2/pool/plugins/org.eclipse.core.databinding.property_1.8.100.v20200619-0651.jar:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.ui/bin:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.ui.view/bin:{home}/.p2/pool/plugins/org.eclipse.xtext.xbase.ui_2.25.0.v20210301-0928.jar:{home}/.p2/pool/plugins/org.eclipse.emf.ecore.edit_2.13.0.v20190822-1451.jar:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.kexpressions.ide/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.kexpressions.ui/bin:{home}/.p2/pool/plugins/org.eclipse.core.externaltools_1.2.0.v20210510-1841.jar:{home}/.p2/pool/plugins/org.eclipse.ui.console_3.11.0.v20210510-1914.jar:{home}/.p2/pool/plugins/org.eclipse.jdt_3.18.800.v20210611-1600.jar:{home}/.p2/pool/plugins/org.eclipse.jdt.core_3.26.0.v20210609-0549.jar:{home}/.p2/pool/plugins/org.eclipse.jdt.compiler.tool_1.2.1200.v20210521-0550.jar:{home}/.p2/pool/plugins/org.eclipse.jdt.compiler.apt_1.3.1300.v20210419-1022.jar:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.kicool.ui/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.simulation/bin:{home}/.p2/pool/plugins/org.eclipse.jetty.server_10.0.5.jar:{home}/.p2/pool/plugins/org.eclipse.jetty.util_10.0.5.jar:{home}/.p2/pool/plugins/org.eclipse.jetty.servlet_10.0.5.jar:{home}/.p2/pool/plugins/de.cau.cs.kieler.websocket.mirror_10.0.5.jar:{home}/oomph/kieler-semantics-keith/ws/.metadata/.plugins/org.eclipse.pde.core/.external_libraries/de.cau.cs.kieler.websocket.mirror_10.0.5/lib/websocket-jetty-server-10.0.5.jar:{home}/oomph/kieler-semantics-keith/ws/.metadata/.plugins/org.eclipse.pde.core/.external_libraries/de.cau.cs.kieler.websocket.mirror_10.0.5/lib/websocket-jetty-api-10.0.5.jar:{home}/oomph/kieler-semantics-keith/ws/.metadata/.plugins/org.eclipse.pde.core/.external_libraries/de.cau.cs.kieler.websocket.mirror_10.0.5/lib/websocket-core-common-10.0.5.jar:{home}/oomph/kieler-semantics-keith/ws/.metadata/.plugins/org.eclipse.pde.core/.external_libraries/de.cau.cs.kieler.websocket.mirror_10.0.5/lib/websocket-core-server-10.0.5.jar:{home}/oomph/kieler-semantics-keith/ws/.metadata/.plugins/org.eclipse.pde.core/.external_libraries/de.cau.cs.kieler.websocket.mirror_10.0.5/lib/websocket-jetty-common-10.0.5.jar:{home}/oomph/kieler-semantics-keith/ws/.metadata/.plugins/org.eclipse.pde.core/.external_libraries/de.cau.cs.kieler.websocket.mirror_10.0.5/lib/websocket-servlet-10.0.5.jar:{home}/.p2/pool/plugins/org.eclipse.jetty.http_10.0.5.jar:{home}/.p2/pool/plugins/org.slf4j.api_1.7.30.v20200204-2150.jar:{home}/.p2/pool/plugins/org.eclipse.jetty.io_10.0.5.jar:{home}/.p2/pool/plugins/org.eclipse.jetty.security_10.0.5.jar:{home}/.p2/pool/plugins/org.eclipse.jetty.util.ajax_10.0.5.jar:{home}/.p2/pool/plugins/jakarta.servlet-api_4.0.0.jar:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.simulation.ide/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.scl.ide/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.sccharts.ide/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.simulation.ui/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.scl.ui/bin:{home}/.p2/pool/plugins/org.eclipse.jdt.debug_3.17.200.v20210513-1223/jdimodel.jar:{home}/.p2/pool/plugins/org.eclipse.jdt.ui_3.23.0.v20210530-1810.jar:{home}/.p2/pool/plugins/org.eclipse.jdt.core.manipulation_1.14.400.v20210531-0737.jar:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.sccharts.ui/bin:{home}/Git/kieler/semantics/test/de.cau.cs.kieler.cli.test/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.core.perspectives/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.core.product/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.esterel/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.esterel.compiler/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.esterel.ide/bin:{home}/Git/kieler/semantics/test/de.cau.cs.kieler.esterel.test/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.esterel.ui/bin:{home}/Git/kieler/semantics/test/de.cau.cs.kieler.kexpressions.text.test/bin:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.kgraph.text.ui/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.kivis/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.kivis.ide/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.kivis.ui/bin:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.piccolo.batik/bin:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.piccolo.batik/lib/lib/batik-bridge.jar:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.piccolo.batik/lib/lib/batik-codec.jar:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.piccolo.batik/lib/lib/batik-extension.jar:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.piccolo.batik/lib/lib/batik-gui-util.jar:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.piccolo.batik/lib/lib/batik-gvt.jar:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.piccolo.batik/lib/lib/batik-script.jar:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.piccolo.batik/lib/lib/batik-swing.jar:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.piccolo.batik/lib/lib/batik-transcoder.jar:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.piccolo.batik/lib/lib/js.jar:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.piccolo.batik/lib/lib/pdf-transcoder.jar:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.piccolo.batik/lib/lib/xalan-2.6.0.jar:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.piccolo.batik/lib/lib/batik-anim.jar:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.piccolo.batik/lib/lib/batik-parser.jar:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.piccolo.batik/lib/lib/batik-xml.jar:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.piccolo.batik/lib/lib/batik-css.jar:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.piccolo.batik/lib/lib/batik-awt-util.jar:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.piccolo.batik/lib/lib/batik-dom.jar:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.piccolo.batik/lib/lib/batik-svg-dom.jar:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.piccolo.batik/lib/lib/batik-svggen.jar:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.piccolo.batik/lib/lib/batik-util.jar:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.piccolo.batik/lib/batik.jar:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.piccolo.draw2d/bin:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.piccolo.freehep/bin:{home}/Git/kieler/KLighD/test/de.cau.cs.kieler.klighd.piccolo.test/bin:{home}/Git/kieler/KLighD/test/de.cau.cs.kieler.klighd.test/bin:/de.cau.cs.kieler.klighd.ui.contrib3x/bin:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.ui.emf/bin:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.ui.wizard/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.lustre/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.lustre.compiler/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.lustre.ide/bin:{home}/Git/kieler/semantics/test/de.cau.cs.kieler.lustre.test/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.lustre.ui/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.overlord/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.sccharts.legacy/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.sccharts.legacy.ui/bin:{home}/Git/kieler/semantics/test/de.cau.cs.kieler.sccharts.test/bin:{home}/Git/kieler/semantics/test/de.cau.cs.kieler.sccharts.test.simulation/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.scg.klighd/bin:{home}/Git/kieler/semantics/test/de.cau.cs.kieler.test.common/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.verification/bin:{home}/Git/kieler/semantics/test/de.cau.cs.kieler.verification.test/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.verification.ui/bin:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.annotations:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.annotations.ide:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.annotations.ui:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.c.sccharts:{home}/Git/kieler/semantics/test/de.cau.cs.kieler.cli.test:{home}/Git/kieler/config:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.core:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.core.perspectives:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.core.product:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.esterel:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.esterel.compiler:{home}/Git/kieler/semantics/features/de.cau.cs.kieler.esterel.feature:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.esterel.ide:{home}/Git/kieler/semantics/test/de.cau.cs.kieler.esterel.test:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.esterel.ui:{home}/Git/kieler/pragmatics/plugins/de.cau.cs.kieler.formats:{home}/Git/kieler/pragmatics/plugins/de.cau.cs.kieler.formats.gml:{home}/Git/kieler/pragmatics/plugins/de.cau.cs.kieler.formats.kgraph:{home}/Git/kieler/semantics/features/de.cau.cs.kieler.framework.feature:{home}/Git/kieler/pragmatics/plugins/de.cau.cs.kieler.graphs.klighd:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.kexpressions:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.kexpressions.ide:{home}/Git/kieler/semantics/test/de.cau.cs.kieler.kexpressions.text.test:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.kexpressions.ui:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.kgraph.text:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.kgraph.text.ide:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.kgraph.text.ui:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.kicool:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.kicool.ide:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.kicool.ui:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.kivis:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.kivis.ide:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.kivis.ui:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd:{home}/Git/kieler/KLighD/features/de.cau.cs.kieler.klighd.batik.feature:{home}/Git/kieler/KLighD/features/de.cau.cs.kieler.klighd.draw2d.feature:{home}/Git/kieler/KLighD/features/de.cau.cs.kieler.klighd.feature:{home}/Git/kieler/KLighD/features/de.cau.cs.kieler.klighd.freehep.feature:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.ide:{home}/Git/kieler/KLighD/features/de.cau.cs.kieler.klighd.ide.feature:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.incremental:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.kgraph:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.krendering:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.krendering.extensions:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.lsp:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.piccolo:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.piccolo.batik:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.piccolo.draw2d:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.piccolo.freehep:{home}/Git/kieler/KLighD/test/de.cau.cs.kieler.klighd.piccolo.test:{home}/Git/kieler/KLighD/build/de.cau.cs.kieler.klighd.repository:{home}/Git/kieler/KLighD/features/de.cau.cs.kieler.klighd.sdk.feature:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.standalone:{home}/Git/kieler/KLighD/build/de.cau.cs.kieler.klighd.targetplatform:{home}/Git/kieler/KLighD/test/de.cau.cs.kieler.klighd.test:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.ui:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.ui.contrib3x:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.ui.emf:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.ui.view:{home}/Git/kieler/KLighD/plugins/de.cau.cs.kieler.klighd.ui.wizard:{home}/Git/kieler/KLighD/features/de.cau.cs.kieler.klighd.view.feature:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.language.server:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.lustre:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.lustre.compiler:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.lustre.ide:{home}/Git/kieler/semantics/test/de.cau.cs.kieler.lustre.test:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.lustre.ui:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.overlord:{home}/Git/kieler/pragmatics/plugins/de.cau.cs.kieler.pragmatics.language.server:{home}/Git/kieler/semantics/features/de.cau.cs.kieler.product.feature:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.sccharts:{home}/Git/kieler/semantics/features/de.cau.cs.kieler.sccharts.feature:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.sccharts.ide:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.sccharts.legacy:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.sccharts.legacy.ui:{home}/Git/kieler/semantics/test/de.cau.cs.kieler.sccharts.test:{home}/Git/kieler/semantics/test/de.cau.cs.kieler.sccharts.test.simulation:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.sccharts.ui:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.scg:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.scg.klighd:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.scl:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.scl.ide:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.scl.ui:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.simulation:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.simulation.ide:{home}/Git/kieler/semantics/test/de.cau.cs.kieler.test.common:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.verification:{home}/Git/kieler/semantics/test/de.cau.cs.kieler.verification.test:{home}/Git/kieler/semantics/plugins/de.cau.cs.kieler.verification.ui", home = home_dir))
            .args(&[
                &format!("-Dport={}", port),
                "-Dfile.encoding=UTF-8",
                "-Djava.awt.headless=true",
                "-XX:+ShowCodeDetailsInExceptionMessages",
                "de.cau.cs.kieler.language.server.LanguageServer"
            ]).spawn().unwrap()
}

fn handle_connection(con: TcpStream, port: u16) {
    std::thread::spawn(move || {
        let mut proc = spawn_lsp(port);

        let mut client_read = con.try_clone().unwrap();
        let mut client_write = con;

        std::thread::sleep(Duration::from_secs(5));

        let server_con = loop {
            let server_con =
                std::net::TcpStream::connect(SocketAddr::from((Ipv4Addr::LOCALHOST, port)));
            if let Ok(con) = server_con {
                println!("Connected to Server");
                break con;
            } else if let Ok(Some(_exit)) = proc.try_wait() {
                return;
            } else {
                println!("Trying again!");
            }
        };

        let mut server_read = server_con.try_clone().unwrap();
        let mut server_write = server_con;

        let join_handle = std::thread::spawn(move || {
            let mut buf = [0; 1024];
            loop {
                match server_read.read(&mut buf) {
                    Ok(0) | Err(_) => break,
                    Ok(bytes) => {
                        let _ = client_write.write_all(&buf[..bytes]);
                    }
                }
            }
        });

        let mut buf = [0; 1024];

        loop {
            match client_read.read(&mut buf) {
                Ok(0) | Err(_) => break,
                Ok(bytes) => {
                    let _ = server_write.write_all(&buf[..bytes]);
                }
            }
        }

        let _ = proc.kill();
        let _ = proc.wait();
        let _ = join_handle.join();
        println!("Finished handling a connection and cleanup!")
    });
}
